FROM ubuntu:20.04

ENV DEBIAN_FRONTEND noninteractive

ARG USER_ID	
ARG USER_NAME	
ARG GROUP_ID	
ARG GROUP_NAME	

RUN apt update

RUN apt-get update

RUN apt-get install -y xvfb tzdata locales language-pack-en rsync wget x11-utils sudo

RUN apt-get install -y python3-pip libtinfo5

RUN locale-gen

RUN ln -fs /usr/share/zoneinfo/America/Los_Angeles /etc/localtime && dpkg-reconfigure --frontend noninteractive tzdata

RUN dpkg --add-architecture i386

RUN mkdir -p /opt/vmr

WORKDIR /opt/vmr/

RUN cd /tmp && wget https://github.com/Xilinx/XRT/raw/master/src/runtime_src/tools/scripts/xrtdeps.sh && chmod +x xrtdeps.sh && ./xrtdeps.sh -docker

RUN groupadd hd -g 10115 && useradd -g hd xbuild -u 65673 && usermod -a -G sudo xbuild

RUN apt --fix-broken -y install 

RUN apt --fix-missing -y install 

RUN echo "ALL ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers	

# Create dirs needed for user	
RUN mkdir -p /home/xbuild  && chmod -R a+rw /home/xbuild

RUN mkdir -p /tmp/runner && chmod -R a+rw /tmp/runner

RUN apt-get install -y jq

COPY start.sh /tmp/

COPY actions-runner-linux-x64-2.285.1.tar.gz /tmp/runner

#RUN cd /tmp/runner && curl -o actions-runner-linux-x64-2.285.1.tar.gz -L -H 'Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IkFTM3RGX0NyRlJkMFVmOUlrVEJFLU9pRjhHWSJ9.eyJuYW1laWQiOiJkZGRkZGRkZC1kZGRkLWRkZGQtZGRkZC1kZGRkZGRkZGRkZGQiLCJzY3AiOiJBY3Rpb25zUnVudGltZS5QYWNrYWdlRG93bmxvYWQiLCJJZGVudGl0eVR5cGVDbGFpbSI6IlN5c3RlbTpTZXJ2aWNlSWRlbnRpdHkiLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9zaWQiOiJERERERERERC1ERERELUREREQtRERERC1EREREREREREREREQiLCJodHRwOi8vc2NoZW1hcy5taWNyb3NvZnQuY29tL3dzLzIwMDgvMDYvaWRlbnRpdHkvY2xhaW1zL3ByaW1hcnlzaWQiOiJkZGRkZGRkZC1kZGRkLWRkZGQtZGRkZC1kZGRkZGRkZGRkZGQiLCJhdWkiOiJkM2E5NTU0ZC05YmViLTRmNmEtYWVhYi0xZDNiY2FhOGNmZmIiLCJzaWQiOiIwYzkyMDA4ZC1kZmYwLTQ5ZjEtOWE5Ni00N2FiMTlkZDEzYWUiLCJpc3MiOiJnaXRlbnRlcnByaXNlLnhpbGlueC5jb20iLCJhdWQiOiJnaXRlbnRlcnByaXNlLnhpbGlueC5jb20iLCJuYmYiOjE2NTE2OTc4MTQsImV4cCI6MTY1MTcwMjAxNH0.ZZb-gOOO9ocXmZ1YwloBJIiB_EL2r6HK5bPqj4meYfLHJ8aIthDtq0VbtT58WZbEzlKhdwU6SmwBP5NFTKuNOWFerb54GX-o48R3l7Ps2V3cMdYJb-skXhbSXBsllZtpQZECDNyaTHtKEfy4un6cCG9fDa8ik3oqNWVsvA4m7t9VX4Ok1oK6KFzHU6VuOl-_2HZ3fdxHdqC6R2yoshCCoQvg3J4gekAJAXYXkKitUvGXohcFBsw5uNlAfC7_pt3T5oaxoatsRxm6xtXbCG1kueDUgheDhN9fuNf2TlZbkqY85XiFruPN8oWh3lC-CbByWr8SylynvPklgWWAtG0AuFwUYXDoZgN8jMvSTSsgwKQH7MoLlQatzMGNgSuhqenW5C8pAJSkwJSYJgyDvuw6Fk54Ctkj9p7qQul9V3_YHqGN3VBmMNQTIlNUa7fgzua9eSNSsMPfCFNsW6G63iu_25Fow6AWPJbXLj77PocdDKtDWky974i0Gq9PXGfukmXz2H_oqwrdFyG3IXd91oMUGg4h_HwB2sUZvSOnGkXcsvU4Aubu2PoGw9dDGC34GT6OdUEWMiUowsxt941eJ7UGzWr_K_1dHffBslLIObjbAmUQIJvRXuJVGf4MgY0_QR6IgEMmwVbp6F6KM1TG_xJPeIptkOH9RtxGQmQH9RrGVfg' https://gitenterprise.xilinx.com/_services/pipelines/_apis/distributedtask/packagedownload/agent/linux-x64/2.285.1

#COPY actions-runner-linux-x64-2.279.0.tar.gz /tmp/runner

RUN cd /tmp/runner && tar -xzf actions-runner-linux-*.tar.gz && chown -R ${USER_NAME}:${GROUP_NAME} /tmp/runner /tmp/start.sh 

CMD [ "bash", "/tmp/start.sh", "ubuntu2004"]
